# [内容协商](https://www.django-rest-framework.org/api-guide/content-negotiation/#content-negotiation)

> HTTP提供了几种用于“内容协商”的机制-当存在多个表示形式时，为给定响应选择最佳表示形式的过程。
>
> — Fielding等人的[RFC 2616](https://www.w3.org/Protocols/rfc2616/rfc2616-sec12.html)。

内容协商是根据客户端或服务器的偏好选择多个可能的表示形式之一返回客户端的过程。

## [确定可接受的渲染器](https://www.django-rest-framework.org/api-guide/content-negotiation/#determining-the-accepted-renderer)

REST框架使用简单的内容协商样式，根据可用的渲染器，每个渲染器的优先级以及客户端的`Accept:`标头，确定应将哪种媒体类型返回给客户端。使用的样式部分是客户端驱动的，部分是服务器驱动的。

1. 较具体的媒体类型优先于较不具体的媒体类型。
2. 如果多种媒体类型具有相同的特异性，则根据为给定视图配置的渲染器的顺序来优先考虑。

例如，给定以下`Accept`标头：

```
application/json; indent=4, application/json, application/yaml, text/html, */*
```

每种给定媒体类型的优先级为：

- `application/json; indent=4`
- `application/json`，`application/yaml`和`text/html`
- `*/*`

如果请求的观点仅渲染器配置`YAML`和`HTML`，然后休息框架会选择哪个渲染器，在首批上市`renderer_classes`名单或`DEFAULT_RENDERER_CLASSES`设置。

有关`HTTP Accept`标题的更多信息，请参见[RFC 2616。](https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html)

------

**注意**：REST框架在确定首选项时不会考虑“ q”值。使用“ q”值会对缓存产生负面影响，并且在作者看来，它们是内容协商中不必要且过于复杂的方法。

这是一种有效的方法，因为HTTP规范故意未指定服务器应如何权衡基于服务器的首选项和基于客户端的首选项。

------

# [定制内容谈判](https://www.django-rest-framework.org/api-guide/content-negotiation/#custom-content-negotiation)

您不太可能希望为REST框架提供自定义内容协商方案，但是可以在需要时这样做。要实现自定义内容协商方案，请重写`BaseContentNegotiation`。

REST框架的内容协商类可以处理对请求的适当解析器和对响应的适当渲染器的选择，因此您应同时实现`.select_parser(request, parsers)`和`.select_renderer(request, renderers, format_suffix)`方法。

该`select_parser()`方法应该从可用的解析器列表中返回一个解析器实例，或者`None`如果没有解析器可以处理传入的请求。

该`select_renderer()`方法应返回一个二元组（渲染器实例，媒体类型），或引发`NotAcceptable`异常。

## [例](https://www.django-rest-framework.org/api-guide/content-negotiation/#example)

以下是一个自定义内容协商类，在选择适当的解析器或渲染器时，它将忽略客户端请求。

```
from rest_framework.negotiation import BaseContentNegotiation

class IgnoreClientContentNegotiation(BaseContentNegotiation):
    def select_parser(self, request, parsers):
        """
        Select the first parser in the `.parser_classes` list.
        """
        return parsers[0]

    def select_renderer(self, request, renderers, format_suffix):
        """
        Select the first renderer in the `.renderer_classes` list.
        """
        return (renderers[0], renderers[0].media_type)
```

## [设置内容协商](https://www.django-rest-framework.org/api-guide/content-negotiation/#setting-the-content-negotiation)

可以使用该`DEFAULT_CONTENT_NEGOTIATION_CLASS`设置全局设置默认内容协商类。例如，以下设置将使用我们的示例`IgnoreClientContentNegotiation`类。

```
REST_FRAMEWORK = {
    'DEFAULT_CONTENT_NEGOTIATION_CLASS': 'myapp.negotiation.IgnoreClientContentNegotiation',
}
```

您还可以使用`APIView`基于类的视图来设置用于单个视图或视图集的内容协商。

```
from myapp.negotiation import IgnoreClientContentNegotiation
from rest_framework.response import Response
from rest_framework.views import APIView

class NoNegotiationView(APIView):
    """
    An example view that does not perform content negotiation.
    """
    content_negotiation_class = IgnoreClientContentNegotiation

    def get(self, request, format=None):
        return Response({
            'accepted media type': request.accepted_renderer.media_type
        })
```