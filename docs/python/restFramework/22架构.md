# [架构图](https://www.django-rest-framework.org/api-guide/schemas/#schema)

> 机器可读的[模式]描述可以通过API使用哪些资源，它们的URL，它们的表示方式以及它们支持的操作。
>
> — Heroku，[Heroku平台API的JSON架构] [cite]

API模式是一个有用的工具，可用于各种用例，包括生成参考文档或驱动可与API交互的动态客户端库。

Django REST Framework提供了对自动生成 [OpenAPI](https://github.com/OAI/OpenAPI-Specification)模式的支持。

## [生成OpenAPI架构](https://www.django-rest-framework.org/api-guide/schemas/#generating-an-openapi-schema)

### [安装 `pyyaml`](https://www.django-rest-framework.org/api-guide/schemas/#install-pyyaml)

您需要安装`pyyaml`，以便可以将生成的架构呈现为常用的基于YAML的OpenAPI格式。

```
pip install pyyaml
```

### [使用`generateschema`管理命令生成静态模式](https://www.django-rest-framework.org/api-guide/schemas/#generating-a-static-schema-with-the-generateschema-management-command)

如果您的架构是静态的，则可以使用`generateschema`管理命令：

```
./manage.py generateschema > openapi-schema.yml
```

以这种方式生成模式后，您可以使用模式生成器无法自动推断的任何其他信息对其进行注释。

您可能需要将API模式检查到版本控制中并在每个新发行版中进行更新，或者从站点的静态媒体提供API模式。

### [使用生成动态模式 `SchemaView`](https://www.django-rest-framework.org/api-guide/schemas/#generating-a-dynamic-schema-with-schemaview)

如果您需要动态架构，例如，由于外键选择取决于数据库值，则可以路由`SchemaView`将根据需要生成和提供架构的a。

要路由`SchemaView`，请使用`get_schema_view()`帮助器。

在`urls.py`：

```
from rest_framework.schemas import get_schema_view

urlpatterns = [
    # ...
    # Use the `get_schema_view()` helper to add a `SchemaView` to project URLs.
    #   * `title` and `description` parameters are passed to `SchemaGenerator`.
    #   * Provide view name for use with `reverse()`.
    path('openapi', get_schema_view(
        title="Your Project",
        description="API for all things …",
        version="1.0.0"
    ), name='openapi-schema'),
    # ...
]
```

#### [`get_schema_view()`](https://www.django-rest-framework.org/api-guide/schemas/#get_schema_view)

该`get_schema_view()`助手采用以下关键字参数：

- `title`：可用于为模式定义提供描述性标题。

- `description`：较长的描述性文字。

- `version`：API的版本。

- `url`：可用于传递模式的规范基础URL。

  ```
  schema_view = get_schema_view(
      title='Server Monitoring API',
      url='https://www.example.org/api/'
  )
  ```

- `urlconf`：一个字符串，表示要为其生成API架构的URL conf的导入路径。默认为Django `ROOT_URLCONF`设置的值 。

  ```
  schema_view = get_schema_view(
      title='Server Monitoring API',
      url='https://www.example.org/api/',
      urlconf='myproject.urls'
  )
  ```

- `patterns`：限制模式自检的网址格式列表。如果只希望`myproject.api`在架构中公开网址：

  ```
  schema_url_patterns = [
      url(r'^api/', include('myproject.api.urls')),
  ]
  
  schema_view = get_schema_view(
      title='Server Monitoring API',
      url='https://www.example.org/api/',
      patterns=schema_url_patterns,
  )
  ```

- `generator_class`：可用于指定`SchemaGenerator`要传递给的子类`SchemaView`。

- `authentication_classes`：可用于指定将应用于架构端点的身份验证类的列表。默认为 `settings.DEFAULT_AUTHENTICATION_CLASSES`

- `permission_classes`：可用于指定将应用于架构端点的权限类别列表。默认为 `settings.DEFAULT_PERMISSION_CLASSES`。

- `renderer_classes`：可用于传递可用于渲染API根端点的渲染器类集。

## [自定义架构生成](https://www.django-rest-framework.org/api-guide/schemas/#customizing-schema-generation)

您可以在整个架构级别或每个视图的基础上自定义架构生成。

### [架构级别自定义](https://www.django-rest-framework.org/api-guide/schemas/#schema-level-customization)

为了自定义顶级架构子集， `rest_framework.schemas.openapi.SchemaGenerator`并将其作为`generateschema`命令或`get_schema_view()`辅助函数的参数提供。

#### [模式生成器](https://www.django-rest-framework.org/api-guide/schemas/#schemagenerator)

一个类，该类遍历路由的URL模式的列表，为每个视图请求模式并整理生成的OpenAPI模式。

通常，您将`SchemaGenerator`使用`title`参数实例化，如下所示：

```
generator = SchemaGenerator(title='Stock Prices API')
```

参数：

- `title` **required**：API的名称。
- `description`：较长的描述性文字。
- `version`：API的版本。默认为`0.1.0`。
- `url`：API模式的根URL。除非架构包含在路径前缀下，否则不需要此选项。
- `patterns`：生成架构时要检查的URL列表。默认为项目的URL conf。
- `urlconf`：生成架构时要使用的URL conf模块名称。默认为`settings.ROOT_URLCONF`。

##### [get_schema（自己，要求）](https://www.django-rest-framework.org/api-guide/schemas/#get_schemaself-request)

返回表示OpenAPI模式的字典：

```
generator = SchemaGenerator(title='Stock Prices API')
schema = generator.get_schema()
```

该`request`参数是可选的，如果要对生成的模式生成应用每用户权限，则可以使用该参数。

如果要自定义生成的字典（例如添加自定义[规范扩展）](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#specification-extensions)，则可以覆盖该方法 。

### [按视图自定义](https://www.django-rest-framework.org/api-guide/schemas/#per-view-customization)

默认情况下，视图自省由`AutoSchema`可通过`schema`on 的属性访问的实例执行`APIView`。这为视图，请求方法和路径提供了适当的[Open API操作对象](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#operationObject)：

```
auto_schema = view.schema
operation = auto_schema.get_operation(...)
```

在编译架构时，`SchemaGenerator`调用`view.schema.get_operation()` 每个视图，允许的方法和路径。

------

**注意**：对于基本`APIView`子类，默认自省本质上仅限于URL kwarg路径参数。对于`GenericAPIView` 包括所有提供的基于类的视图的子类，`AutoSchema`将尝试内省序列化器，分页和过滤器字段，并提供更丰富的路径字段描述。（这里的关键是挂钩的相关 `GenericAPIView`属性和方法：`get_serializer`，`pagination_class`， `filter_backends`等。）

------

为了自定义操作生成，您应该提供一个`AutoSchema`子类，`get_operation()`根据需要进行覆盖：

```
    from rest_framework.views import APIView
    from rest_framework.schemas.openapi import AutoSchema

    class CustomSchema(AutoSchema):
        def get_operation(...):
            # Implement custom introspection here (or in other sub-methods)

    class CustomView(APIView):
        """APIView subclass with custom schema introspection."""
        schema = CustomSchema()
```

这样可以完全控制视图自省。

您可以通过设置`schema`为来禁用视图的架构生成`None`：

```
class CustomView(APIView):
    ...
    schema = None  # Will not appear in schema
```

这也适用于的额外操作`ViewSet`：

```
class CustomViewSet(viewsets.ModelViewSet):

    @action(detail=True, schema=None)
    def extra_action(self, request, pk=None):
        ...
```

如果希望提供`AutoSchema`在整个项目中使用的基本子类，则可以进行`settings.DEFAULT_SCHEMA_CLASS` 适当调整。