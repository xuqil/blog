# [通用视图](https://www.django-rest-framework.org/api-guide/generic-views/#generic-views)

> Django的通用视图...是作为通用用法模式的快捷方式而开发的...它们采用视图开发中发现的某些通用习语和模式并将其抽象化，以便您可以快速编写通用数据视图而无需重复自己。
>
> — [Django文档](https://docs.djangoproject.com/en/stable/ref/class-based-views/#base-vs-generic-views)

基于类的视图的主要优点之一是它们允许您组成一些可重用行为的方式。REST框架通过提供许多提供常用模式的预构建视图来利用此优势。

REST框架提供的通用视图使您可以快速构建与数据库模型紧密映射的API视图。

如果通用视图不符合您的API的需求，则可`APIView`以下拉到使用常规类，或者重用通用视图使用的mixins和基类来组成自己的可重用通用视图集。

## [例子](https://www.django-rest-framework.org/api-guide/generic-views/#examples)

通常，在使用通用视图时，您将覆盖视图并设置几个类属性。

```python
from django.contrib.auth.models import User
from myapp.serializers import UserSerializer
from rest_framework import generics
from rest_framework.permissions import IsAdminUser

class UserList(generics.ListCreateAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    permission_classes = [IsAdminUser]
```

对于更复杂的情况，您可能还想覆盖视图类上的各种方法。例如。

```python
class UserList(generics.ListCreateAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    permission_classes = [IsAdminUser]

    def list(self, request):
        # Note the use of `get_queryset()` instead of `self.queryset`
        queryset = self.get_queryset()
        serializer = UserSerializer(queryset, many=True)
        return Response(serializer.data)
```

对于非常简单的情况，您可能希望使用`.as_view()`方法传递任何类属性。例如，您的URLconf可能包含类似以下条目的内容：

```python
url(r'^/users/', ListCreateAPIView.as_view(queryset=User.objects.all(), serializer_class=UserSerializer), name='user-list')
```

------

# [API参考](https://www.django-rest-framework.org/api-guide/generic-views/#api-reference)

## [GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)

该类扩展了REST框架的`APIView`类，为标准列表和详细信息视图添加了通常需要的行为。

提供的每个具体的通用视图都是通过将`GenericAPIView`，和一个或多个mixin类组合而构建的。

### [属性](https://www.django-rest-framework.org/api-guide/generic-views/#attributes)

**基本设定**：

以下属性控制基本视图行为。

- `queryset`-应该用于从该视图返回对象的查询集。通常，您必须设置此属性或重写`get_queryset()`方法。如果要覆盖视图方法，则必须进行调用`get_queryset()`而不是直接访问此属性，这`queryset`将被评估一次，并且这些结果将被缓存用于所有后续请求，这一点很重要。
- `serializer_class`-应该用于验证和反序列化输入以及序列化输出的序列化器类。通常，您必须设置此属性或重写`get_serializer_class()`方法。
- `lookup_field`-应该用于执行单个模型实例的对象查找的模型字段。默认为`'pk'`。需要注意的是使用超链接的API时，您需要确保*双方*的API意见*和*串行类设置查找字段，如果你需要使用一个自定义值。
- `lookup_url_kwarg`-用于对象查找的URL关键字参数。URL conf应包含与此值相对应的关键字参数。如果未设置，则默认使用与相同的值`lookup_field`。

**分页**：

与列表视图一起使用时，以下属性用于控制分页。

- `pagination_class`-对列表进行分页时应使用的分页类。默认值为与`DEFAULT_PAGINATION_CLASS`设置相同的值`'rest_framework.pagination.PageNumberPagination'`。设置`pagination_class=None`将禁用此视图上的分页。

**筛选**：

- `filter_backends`-应该用于过滤查询集的过滤器后端类的列表。默认值为与`DEFAULT_FILTER_BACKENDS`设置相同的值。

### [方法](https://www.django-rest-framework.org/api-guide/generic-views/#methods)

**基本方法**：

#### [`get_queryset(self)`](https://www.django-rest-framework.org/api-guide/generic-views/#get_querysetself)

返回应用于列表视图的查询集，该查询集应用作详细视图中的查询的基础。默认情况下返回`queryset`属性指定的查询集。

应始终使用此方法，而不是`self.queryset`直接访问此方法，因为它`self.queryset`只会被评估一次，并且那些结果将为所有后续请求缓存。

可以重写以提供动态行为，例如返回特定于发出请求的用户的查询集。

例如：

```python
def get_queryset(self):
    user = self.request.user
    return user.accounts.all()
```

#### [`get_object(self)`](https://www.django-rest-framework.org/api-guide/generic-views/#get_objectself)

返回应用于详细信息视图的对象实例。默认为使用`lookup_field`参数过滤基本查询集。

可以重写以提供更复杂的行为，例如基于多个URL kwarg的对象查找。

例如：

```python
def get_object(self):
    queryset = self.get_queryset()
    filter = {}
    for field in self.multiple_lookup_fields:
        filter[field] = self.kwargs[field]

    obj = get_object_or_404(queryset, **filter)
    self.check_object_permissions(self.request, obj)
    return obj
```

请注意，如果您的API不包含任何对象级别的权限，则可以选择排除`self.check_object_permissions`，而只需从`get_object_or_404`查找中返回对象即可。

#### [`filter_queryset(self, queryset)`](https://www.django-rest-framework.org/api-guide/generic-views/#filter_querysetself-queryset)

给定一个查询集，请使用正在使用的任何过滤器后端对其进行过滤，并返回一个新的查询集。

例如：

```python
def filter_queryset(self, queryset):
    filter_backends = [CategoryFilter]

    if 'geo_route' in self.request.query_params:
        filter_backends = [GeoRouteFilter, CategoryFilter]
    elif 'geo_point' in self.request.query_params:
        filter_backends = [GeoPointFilter, CategoryFilter]

    for backend in list(filter_backends):
        queryset = backend().filter_queryset(self.request, queryset, view=self)

    return queryset
```

#### [`get_serializer_class(self)`](https://www.django-rest-framework.org/api-guide/generic-views/#get_serializer_classself)

返回应用于序列化程序的类。默认为返回`serializer_class`属性。

可以重写以提供动态行为，例如使用不同的序列化程序进行读写操作，或为不同类型的用户提供不同的序列化程序。

例如：

```python
def get_serializer_class(self):
    if self.request.user.is_staff:
        return FullAccountSerializer
    return BasicAccountSerializer
```

**保存和删除钩子(hooks)**：

mixin类提供了以下方法，它们提供了覆盖对象保存或删除行为的简便方法。

- `perform_create(self, serializer)`- `CreateModelMixin`保存新对象实例时调用。
- `perform_update(self, serializer)`- `UpdateModelMixin`保存现有对象实例时调用。
- `perform_destroy(self, instance)`- `DestroyModelMixin`删除对象实例时调用。

这些挂钩对于设置请求中隐含但不属于请求数据的属性特别有用。例如，您可以基于请求用户或基于URL关键字参数在对象上设置属性。

```python
def perform_create(self, serializer):
    serializer.save(user=self.request.user)
```

这些覆盖点对于添加在保存对象之前或之后发生的行为（例如通过电子邮件发送确认或记录更新）也特别有用。

```python
def perform_update(self, serializer):
    instance = serializer.save()
    send_email_confirmation(user=self.request.user, modified=instance)
```

您还可以通过引发来使用这些挂钩提供其他验证`ValidationError()`。如果您需要在数据库保存时应用一些验证逻辑，这将很有用。例如：

```python
def perform_create(self, serializer):
    queryset = SignupRequest.objects.filter(user=self.request.user)
    if queryset.exists():
        raise ValidationError('You have already signed up')
    serializer.save(user=self.request.user)
```

**注意**：这些方法取代旧式的2.x版`pre_save`，`post_save`，`pre_delete`和`post_delete`方法，这将不再可用。

**其他方法**：

尽管使用编写自定义视图，但您可能需要调用以下方法，因此通常不需要重写以下方法`GenericAPIView`。

- `get_serializer_context(self)`-返回包含应提供给序列化程序的任何其他上下文的字典。默认为包括`'request'`，`'view'`和`'format'`关键词。
- `get_serializer(self, instance=None, data=None, many=False, partial=False)` -返回序列化器实例。
- `get_paginated_response(self, data)`-返回分页样式`Response`对象。
- `paginate_queryset(self, queryset)`-如果需要，对查询集进行分页，或者返回页面对象，或者`None`未为此视图配置分页。
- `filter_queryset(self, queryset)` -给定查询集，请使用正在使用的任何过滤器后端对其进行过滤，并返回新的查询集。

------

# [Mixins](https://www.django-rest-framework.org/api-guide/generic-views/#mixins)

mixin类提供用于提供基本视图行为的操作。请注意，mixin类提供了操作方法，而不是直接定义处理程序方法（例如`.get()`和`.post()`）。这样可以更灵活地构成行为。

mixin类可以从导入`rest_framework.mixins`。

## [ListModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#listmodelmixin)

提供一种`.list(request, *args, **kwargs)`方法，该方法实现列出查询集。

如果填充了查询集，则返回一个`200 OK`响应，并将查询集的序列化表示形式作为响应的主体。可以可选地对响应数据进行分页。

## [CreateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#createmodelmixin)

提供一种`.create(request, *args, **kwargs)`方法，该方法实现创建和保存新模型实例。

如果创建了对象，则返回一个`201 Created`响应，该对象的序列化表示作为响应的主体。如果表示形式包含名为的键`url`，则将`Location`使用该值填充响应的标头。

如果提供的用于创建对象的请求数据无效，`400 Bad Request`则将返回响应，并将错误详细信息作为响应的正文。

## [RetrieveModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#retrievemodelmixin)

提供一种`.retrieve(request, *args, **kwargs)`方法，该方法实现在响应中返回现有模型实例。

如果可以检索到对象，则返回一个`200 OK`响应，该对象的序列化表示作为响应的主体。否则将返回`404 Not Found`。

## [UpdateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#updatemodelmixin)

提供一种`.update(request, *args, **kwargs)`方法，该方法实现更新和保存现有模型实例。

还提供了一种`.partial_update(request, *args, **kwargs)`方法，该方法与该`update`方法类似，但是用于更新的所有字段都是可选的。这样可以支持HTTP `PATCH`请求。

如果对象被更新，它将返回一个`200 OK`响应，该对象的序列化表示作为响应的主体。

如果提供的用于更新对象的请求数据无效，`400 Bad Request`则将返回响应，并将错误详细信息作为响应的主体。

## [DestroyModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#destroymodelmixin)

提供一种`.destroy(request, *args, **kwargs)`方法，该方法实现删除现有模型实例。

如果删除对象，则返回`204 No Content`响应，否则将返回`404 Not Found`。

------

# [具体的视图类](https://www.django-rest-framework.org/api-guide/generic-views/#concrete-view-classes)

以下类是具体的通用视图。如果您使用的是通用视图，那么通常这就是您要使用的级别，除非需要大量的自定义行为。

可以从中导入视图类`rest_framework.generics`。

## [CreateAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#createapiview)

用于**仅创建**端点。

提供`post`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[CreateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#createmodelmixin)

## [ListAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#listapiview)

用于**只读**端点，表示**模型实例**的**集合**。

提供`get`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[ListModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#listmodelmixin)

## [RetrieveAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#retrieveapiview)

用于**只读**端点，以表示**单个模型实例**。

提供`get`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[RetrieveModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#retrievemodelmixin)

## [DestroyAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#destroyapiview)

用于**单个模型实例****的仅删除**端点。

提供`delete`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[DestroyModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#destroymodelmixin)

## [UpdateAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#updateapiview)

用于**单个模型实例****的仅更新**端点。

提供`put`和`patch`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[UpdateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#updatemodelmixin)

## [ListCreateAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#listcreateapiview)

用于**读写**端点，表示**模型实例**的**集合**。

提供`get`和`post`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[ListModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#listmodelmixin)，[CreateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#createmodelmixin)

## [RetrieveUpdateAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#retrieveupdateapiview)

用于**读取或更新**端点以表示**单个模型实例**。

提供`get`，`put`并且`patch`方法处理。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[RetrieveModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#retrievemodelmixin)，[UpdateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#updatemodelmixin)

## [RetrieveDestroyAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#retrievedestroyapiview)

用于**读取或删除**端点，以表示**单个模型实例**。

提供`get`和`delete`方法处理程序。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[RetrieveModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#retrievemodelmixin)，[DestroyModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#destroymodelmixin)

## [RetrieveUpdateDestroyAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#retrieveupdatedestroyapiview)

用于**读写删除**端点，以表示**单个模型实例**。

提供`get`，`put`，`patch`和`delete`方法处理。

扩展：[GenericAPIView](https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview)，[RetrieveModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#retrievemodelmixin)，[UpdateModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#updatemodelmixin)，[DestroyModelMixin](https://www.django-rest-framework.org/api-guide/generic-views/#destroymodelmixin)

------

# [自定义通用视图](https://www.django-rest-framework.org/api-guide/generic-views/#customizing-the-generic-views)

通常，您会想要使用现有的通用视图，但会使用一些稍微自定义的行为。如果发现自己在多个地方重用了一些自定义行为，则可能需要将行为重构为一个通用类，然后可以根据需要将其应用于任何视图或视图集。

## [创建自定义mixins](https://www.django-rest-framework.org/api-guide/generic-views/#creating-custom-mixins)

例如，如果您需要基于URL conf中的多个字段查找对象，则可以创建如下的mixin类：

```python
class MultipleFieldLookupMixin(object):
    """
    Apply this mixin to any view or viewset to get multiple field filtering
    based on a `lookup_fields` attribute, instead of the default single field filtering.
    """
    def get_object(self):
        queryset = self.get_queryset()             # Get the base queryset
        queryset = self.filter_queryset(queryset)  # Apply any filter backends
        filter = {}
        for field in self.lookup_fields:
            if self.kwargs[field]: # Ignore empty fields.
                filter[field] = self.kwargs[field]
        obj = get_object_or_404(queryset, **filter)  # Lookup the object
        self.check_object_permissions(self.request, obj)
        return obj
```

然后，您可以在需要应用自定义行为的任何时间简单地将此混入应用于视图或视图集。

```python
class RetrieveUserView(MultipleFieldLookupMixin, generics.RetrieveAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    lookup_fields = ['account', 'username']
```

如果您需要使用自定义行为，则使用自定义混合是一个不错的选择。

## [创建自定义基类](https://www.django-rest-framework.org/api-guide/generic-views/#creating-custom-base-classes)

如果要在多个视图之间使用混合，则可以更进一步，并创建自己的基础视图集，然后将其用于整个项目。例如：

```python
class BaseRetrieveView(MultipleFieldLookupMixin,
                       generics.RetrieveAPIView):
    pass

class BaseRetrieveUpdateDestroyView(MultipleFieldLookupMixin,
                                    generics.RetrieveUpdateDestroyAPIView):
    pass
```

如果您有自定义行为，并且需要在整个项目中的大量视图中重复执行自定义行为，那么使用自定义基类是一个不错的选择。

------

# [PUT 为创建](https://www.django-rest-framework.org/api-guide/generic-views/#put-as-create)

在3.0版之前`PUT`，取决于对象是否存在，REST框架混合将其视为更新或创建操作。

允许`PUT`作为创建操作是有问题的，因为它必须公开有关对象存在或不存在的信息。与简单地返回`404`响应相比，透明地允许重新创建先前删除的实例必然是更好的默认行为，这也不是显而易见的。

“ `PUT`as 404”和“ `PUT`as create” 这两种样式在不同情况下都可以有效，但是从3.0版开始，由于它更简单，更明显，我们现在将404行为用作默认行为。

如果需要通用的PUT即创建行为，则可能需要将[此类之`AllowPUTAsCreateMixin`类的内容](https://gist.github.com/tomchristie/a2ace4577eff2c603b1b)作为混合添加到视图中。

------

# [第三方包](https://www.django-rest-framework.org/api-guide/generic-views/#third-party-packages)

以下第三方软件包提供了其他通用视图实现。

## [Django Rest多种模型](https://www.django-rest-framework.org/api-guide/generic-views/#django-rest-multiple-models)

[Django Rest Multiple Models](https://github.com/MattBroach/DjangoRestMultipleModels)提供了通用视图（和混合），用于通过单个API请求发送多个序列化的模型和/或查询集。