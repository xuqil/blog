# [解析器(Parsers)](https://www.django-rest-framework.org/api-guide/parsers/#parsers)

> 机器交互Web服务倾向于使用比表单编码更多的结构化格式来发送数据，因为它们发送的数据比简单表单还要复杂。
>
> — [Django开发人员小组](https://groups.google.com/d/topic/django-developers/dxI4qVzrBY4/discussion) Malcom Tredinnick

REST框架包括许多内置的Parser类，使您可以接受各种媒体类型的请求。还支持定义自己的自定义解析器，这使您可以灵活地设计API接受的媒体类型。

## [如何确定解析器](https://www.django-rest-framework.org/api-guide/parsers/#how-the-parser-is-determined)

视图的有效解析器集始终定义为类列表。当 `request.data`被访问时，REST框架将检查`Content-Type`传入请求上的标头，并确定使用哪个解析器来解析请求内容。

------

**注意**：开发客户端应用程序时，切记要确保`Content-Type`在HTTP请求中发送数据时设置头。

如果您未设置内容类型，则大多数客户端将默认使用`'application/x-www-form-urlencoded'`，这可能不是您想要的。

例如，如果要`json`使用jQuery和[.ajax（）方法](https://api.jquery.com/jQuery.ajax/)发送编码数据，则应确保包括该`contentType: 'application/json'`设置。

------

## [设置解析器](https://www.django-rest-framework.org/api-guide/parsers/#setting-the-parsers)

可以使用该`DEFAULT_PARSER_CLASSES`设置全局设置默认的解析器集。例如，以下设置将仅允许带有`JSON`内容的请求，而不是默认的JSON或表单数据。

```python
REST_FRAMEWORK = {
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
    ]
}
```

您还可以使用`APIView`基于类的视图来设置用于单个视图或视图集的解析器。

```python
from rest_framework.parsers import JSONParser
from rest_framework.response import Response
from rest_framework.views import APIView

class ExampleView(APIView):
    """
    A view that can accept POST requests with JSON content.
    """
    parser_classes = [JSONParser]

    def post(self, request, format=None):
        return Response({'received data': request.data})
```

或者，如果您将`@api_view`装饰器与基于函数的视图一起使用。

```python
from rest_framework.decorators import api_view
from rest_framework.decorators import parser_classes
from rest_framework.parsers import JSONParser

@api_view(['POST'])
@parser_classes([JSONParser])
def example_view(request, format=None):
    """
    A view that can accept POST requests with JSON content.
    """
    return Response({'received data': request.data})
```

------

# [API参考](https://www.django-rest-framework.org/api-guide/parsers/#api-reference)

## [JSONParser](https://www.django-rest-framework.org/api-guide/parsers/#jsonparser)

解析`JSON`请求内容。

**.media_type**：`application/json`

## [FormParser](https://www.django-rest-framework.org/api-guide/parsers/#formparser)

解析HTML表单内容。 `request.data`将填充`QueryDict`的数据。

您通常希望同时使用`FormParser`和两者，`MultiPartParser`以便完全支持HTML表单数据。

**.media_type**：`application/x-www-form-urlencoded`

## [MultiPartParser](https://www.django-rest-framework.org/api-guide/parsers/#multipartparser)

解析多部分HTML表单内容，支持文件上传。两者都`request.data`将填充`QueryDict`。

您通常希望同时使用`FormParser`和两者，`MultiPartParser`以便完全支持HTML表单数据。

**.media_type**：`multipart/form-data`

## [FileUploadParser](https://www.django-rest-framework.org/api-guide/parsers/#fileuploadparser)

解析原始文件上传内容。该`request.data`属性将是一个字典，`'file'`其中包含包含上载文件的单个键。

如果通过URL关键字参数`FileUploadParser`调用与with一起使用的视图`filename`，则该参数将用作文件名。

如果在没有`filename`URL关键字参数的情况下调用它，则客户端必须在`Content-Disposition`HTTP标头中设置文件名。例如`Content-Disposition: attachment; filename=upload.jpg`。

**.media_type**：`*/*`

##### [笔记：](https://www.django-rest-framework.org/api-guide/parsers/#notes)

- 的`FileUploadParser`是与本地客户端的使用，可以将文件上传的原始数据请求。对于基于Web的上载，或者对于具有分段上载支持的本机客户端，应使用`MultiPartParser`代替。
- 由于此解析器`media_type`匹配任何内容类型，`FileUploadParser`因此通常应该是API视图上设置的唯一解析器。
- `FileUploadParser`遵守Django的标准`FILE_UPLOAD_HANDLERS`设置和`request.upload_handlers`属性。有关更多详细信息，请参见[Django文档](https://docs.djangoproject.com/en/stable/topics/http/file-uploads/#upload-handlers)。

##### [基本用法示例：](https://www.django-rest-framework.org/api-guide/parsers/#basic-usage-example)

```python
# views.py
class FileUploadView(views.APIView):
    parser_classes = [FileUploadParser]

    def put(self, request, filename, format=None):
        file_obj = request.data['file']
        # ...
        # do some stuff with uploaded file
        # ...
        return Response(status=204)

# urls.py
urlpatterns = [
    # ...
    url(r'^upload/(?P<filename>[^/]+)$', FileUploadView.as_view())
]
```

------

# [自定义解析器](https://www.django-rest-framework.org/api-guide/parsers/#custom-parsers)

要实现自定义解析器，应重写`BaseParser`，设置`.media_type`属性并实现`.parse(self, stream, media_type, parser_context)`方法。

该方法应返回将用于填充`request.data`属性的数据。

传递给的参数`.parse()`是：

### [stream](https://www.django-rest-framework.org/api-guide/parsers/#stream)

类似于流的对象，表示请求的主体。

### [media_type](https://www.django-rest-framework.org/api-guide/parsers/#media_type)

可选的。如果提供，这是传入请求内容的媒体类型。

根据请求的`Content-Type:`header，它可能比渲染器的`media_type`属性更具体，并且可能包括媒体类型参数。例如`"text/plain; charset=utf-8"`。

### [parser_context](https://www.django-rest-framework.org/api-guide/parsers/#parser_context)

可选的。如果提供，则此参数将是一个字典，其中包含解析请求内容可能需要的任何其他上下文。

默认情况下，这将包括以下键：`view`，`request`，`args`，`kwargs`。

## [例](https://www.django-rest-framework.org/api-guide/parsers/#example)

下面是一个示例纯文本解析器，它将`request.data`使用代表请求主体的字符串填充属性。

```python
class PlainTextParser(BaseParser):
    """
    Plain text parser.
    """
    media_type = 'text/plain'

    def parse(self, stream, media_type=None, parser_context=None):
        """
        Simply return a string representing the body of the request.
        """
        return stream.read()
```

------

# [第三方软件包](https://www.django-rest-framework.org/api-guide/parsers/#third-party-packages)

以下第三方软件包也可用。

## [YAML](https://www.django-rest-framework.org/api-guide/parsers/#yaml)

[REST框架YAML](https://jpadilla.github.io/django-rest-framework-yaml/)提供了[YAML](http://www.yaml.org/)解析和渲染支持。它以前直接包含在REST框架程序包中，现在已作为第三方程序包受支持。

#### [安装与配置](https://www.django-rest-framework.org/api-guide/parsers/#installation-configuration)

使用pip安装。

```python
$ pip install djangorestframework-yaml
```

修改您的REST框架设置。

```python
REST_FRAMEWORK = {
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework_yaml.parsers.YAMLParser',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework_yaml.renderers.YAMLRenderer',
    ],
}
```

## [XML格式](https://www.django-rest-framework.org/api-guide/parsers/#xml)

[REST Framework XML](https://jpadilla.github.io/django-rest-framework-xml/)提供了一种简单的非正式XML格式。它以前直接包含在REST框架程序包中，现在已作为第三方程序包受支持。

#### [安装与配置](https://www.django-rest-framework.org/api-guide/parsers/#installation-configuration_1)

使用pip安装。

```python
$ pip install djangorestframework-xml
```

修改您的REST框架设置。

```python
REST_FRAMEWORK = {
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework_xml.parsers.XMLParser',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework_xml.renderers.XMLRenderer',
    ],
}
```

## [消息包](https://www.django-rest-framework.org/api-guide/parsers/#messagepack)

[MessagePack](https://github.com/juanriaza/django-rest-framework-msgpack)是一种快速，高效的二进制序列化格式。 [Juan Riaza](https://github.com/juanriaza)维护[djangorestframework-msgpack](https://github.com/juanriaza/django-rest-framework-msgpack)软件包，该软件包为REST框架提供MessagePack渲染器和解析器支持。

## [CamelCase JSON](https://www.django-rest-framework.org/api-guide/parsers/#camelcase-json)

[djangorestframework-camel-case](https://github.com/vbabiy/djangorestframework-camel-case)提供REST框架[的驼峰式](https://github.com/vbabiy/djangorestframework-camel-case) JSON渲染器和解析器。这允许序列化程序使用Python样式的带下划线的字段名称，但在API中以Javascript样式的驼峰式大小写字段名称公开。它由[Vitaly Babiy](https://github.com/vbabiy)维护。